---
title: " Does the National Health Service Corps Help Underserved Areas?"
author: "Sarah Van Alsten"
output:
  pdf_document: 
    latex_engine: lualatex
    includes:  
      in_header: myheader.tex
indent: true
---
\fontsize{12}{22}
```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(rdd)
library(rdrobust)
library(kableExtra)
library(tableone)
```


## Background and Aims
Medically underserved areas are communities with a high levels of unmet healthcare needs, often secondary to insufficient access to primary care physicians (Shi et al., 2005; Starfield, Shi, & Macinko, 2005). Formal designations of underserved areas began in the late 1980s and is based on the Index of Medical Underservice (IMU), a weighted score of census or county-level infant mortality rate, primary care provider to population ratio, percent of population older than 65, and percent of population below the federal poverty line (“Development of the index of medical underservice,” 1975). Although primary care recruitment to and subsequent health improvement in underserved areas are often cited targets for healthcare and physician workgroups, medically underserved areas are consistently faced with physician shortages. Determinants of shortages include lack of physician exposure to rural health in medical school, individual preference to work in urban centers, lower pay for primary care specialties, and hospital closures (Fagan et al., 2015; Parlier, Galvin, Thach, Kruidenier, & Fagan, 2018; Rabinowitz, Diamond, Markham, & Paynter, 2001).
  
To increase physician supply to underserved areas, several loan repayment and subsidized training programs for primary care practitioners have been instituted, including the National Health Service Corps (NHSC) through the U.S. Department of Health and Human Services (National Health Service Corps Scholarship Program, 2003). The NHSC grants primary care physicians up to \$50,000 in medical school loan forgiveness in exchange for two years of service in a medically underserved area, although select states offer additional compensation. Early assessments of the NHSC have shown the program to be successful in recruiting physicians to areas of high need (Holmes, 2005); unfortunately, less than half of participating physicians remain in their initial area of service after completion of the program, leading to high rates of turnover and lack of continuity in the care of underserved community members (Heisler, 2017; Pathman, Konrad, Dann, & Koch, 2004). Further, despite the purported goal of primary care recruitment programs in improving population health, few evaluations have explored the effects of the NHSC on population health indicators. 

The aim of this analysis is to determine whether participation in the NHSC reduces county-level all-cause and disease-specific mortality (herein, simply ‘mortality’). $\newline$

## Method

Data for this study come from three sources: one, the Area Health Resource Files (US Department of
Health and Human Services, 2014) for the ratio of primary care physicians-to-population; two, the American Community Survey (ACS) (U.S. Census Bureau; American Community Survey, 2014) for population estimates, age demographics, and poverty and unemployment rates; three, the Centers for Disease Control Wide-ranging Online Data for Epidemiologic Research (CDC WONDER) (Centers for Disease Control and Prevention, 1995) for infant mortality rates, low birthweight rates, and crude all-cause, cancer, and heart disease mortality rates. Briefly, the Area Health Resource Files are a compilation of 50 separate health service and economic datasets provided by the American Medical Association, American Hospital Association, and Bureau of Health Workforce. Files are updated annually to monitor health service worker supply, regional demand for specific medical procedures (e.g. elective surgery, orthodontia), and costs of care. Among the provided indicators is a census of all physicians licensed in the U.S., disaggregated by county of practice and medical specialty. The ACS is an ongoing, nationally representative, multistage probability sample conducted by the U.S. Census Bureau as a supplement to the decennial census. Roughly 0.6% of the U.S. population is sampled for the ACS in any given year, and, because the Census Bureau contacts respondents multiple time to encourage participation, the response rate in 2014 was 96.7% (Torrieri, 2014). The ACS includes census tract-level demographics including estimates of population by age group and race/ethnicity, poverty, unemployment, and educational attainment. Finally, CDC WONDER is an online query system maintained by the National Center for Health Statistics that allows users to generate area- and period-level natality and mortality data from linkage to birth records and the National Death Index (> 90% of all deaths are accounted for in any given year) for all U.S. counties between 1999 and 2016. Area-level mortality rates disaggregated by age are provided for the 57 leading causes of death as determined by death certificate listed ICD-10 codes, although rates are suppressed for regions with fewer than 10 deaths from a specific cause.  $\newline$

*Index of Medical Underservice Scoring*

  A county’s eligibility to participate in the NHSC is determined by the index of medical underservice score, which quantifies an area’s degree of physician shortage relative to healthcare needs. Scores are typically generated automatically by the Health Resource and Service Administration from Area Health Resource Files, CDC WONDER, and Census data, with all scores of 62 or below eligible for NHSC participation. Although historic data on county eligibility are publicly available, actual index of medical underservice scores are only provided for counties currently eligible for the NHSC (i.e. in 2019; 2020 eligibility has not yet been determined). Thus, to obtain index of medical underservice scores for earlier years, I regenerate scores for each county in the U.S. using historic data and the Health Resource and Service Administration scoring guidelines (U.S. Department of Health and Human Services, 2015). Scores are calculated as the weighted sum of a county’s primary care physician-to-population ratio, percentage of residents age 65 or older, percentage of population at or below the federal poverty level, and infant mortality rate or, in instances where infant mortality rates were suppressed due to small sample sizes, rates of low birthweight. All score subcomponents are based on five-year averages to prevent substantial annual variation in program eligibility for treated counties (i.e. the averages of 2009-2014 components were used to calculate 2014 scores), and counties with qualifying scores automatically retain eligibility for two years following designation, regardless of subsequent scores. Though the NHSC has been in operation since the late 1970s, the current index of medical underservice scoring criteria were first implemented in 2014 such that all potential carry-overs from 2012/2013 to 2014 were disallowed. Thus, unlike for earlier periods, a county’s NHSC participation in 2014 is based strictly on its 2014 score rather than any one of its 2012, 2013, or 2014 scores. Table 1 provides a more detailed description of scoring criteria and weighting procedures.  $\newline$

*Treatment Assignment and Identification*

  Let $Z_i$ be a dichotomous variable denoting the eligibility of county $i$ to participate in the NHSC in 2014 (with 0 = ineligible, 1 = eligible). Also let $X_i$ denote the index of medical underservice score in 2014, and $D_i$ (1 = treated, 0 = control) denote actual participation in 2014. $Z_i$ is a deterministic function of $X_i$ such that:
$$
E[Z_i | X_i] = \begin{cases} 1 \text{ if }X_i \le 62\\0 \text{ if }X_i > 62
\end{cases}
$$
  
  Due to budget constraints, not all eligible counties receive NHSC funding; however, no ineligible counties receive funding. Therefore, $D_i$ is a probabilistic function of eligibility $f(Z_i)$ for counties below the cutoff, and deterministic for counties above such that:
$$
E[D_i | Z_i] = 
\begin{cases} 
f(Z_i) &  \text{ if }Z_i =1 \\
0        & \text{ if }Z_i = 0
\end{cases}
\text{where } f(Z_i) \ne 0
$$

  Because of this feature, monotonicity is guaranteed to hold, with the exception that state governors may grant exemptions for ineligible rural counties with demonstrated primary care shortages to receive funding for rural health clinics. However, the application process for exemption is long and requires extensive administrative oversight, with few requests ultimately being approved, so the population of defiers is both known and small (a total of five counties were exempted in 2014, all of which I exclude from further analyses). As shown in Table 2, derived treatment assignment according to simulated scores adhered to known participation and eligibility rules, with zero counties above the cutoff participating and approximately one-half of those below participating. 
  
  In addition to monotonicity, the ability to identify the RDD effect as the local average treatment effect for the subpopulation of compliers (i.e. counties which are not perpetually enrolled- or never enrolled- in the program) which have IMU scores near the cutoff hinges upon several additional assumptions, namely, continuity in potential outcomes and potential treatment near the threshold, the relevance of $Z$, and the exclusion restriction. While it is not necessarily possible to assess continuity in potential outcomes, I assess balance in covariates for counties just above and below the cutpoint and, to assess potential manipulation of the running variable $X_i$, I check for discontinuity in the density of observations just above and below the cutoff score (McCrary, 2008). I evaluate the relevance of $Z$ using weak instrument tests. Finally, in regards to the exclusion restriction, eligiblity itself should not be linked to mortality other than through actual program participation, as NHSC funding cannot be used for other healthcare needs and does not impact eligibility for other population health programs. It is also expected that eligibility would not influence mortality through economic progress - at most, one to two physicians per county are recruited, which should neither appreciably increase county population nor substantially stimulate local economic conditions. Of greater threat to exogeneity are the IMU score components themselves, in particular poverty and age (infant mortality is excluded from other mortality estimates, while physician supply is the direct target of the program and is less apt to influence health other than through actual patient care; see Figure 4 in supplement). Assuming counties just above and below the cutoff are balanced on these components improves the capacity for identification, therefore, I test this explicitly in sensitivity analyses. However, population age distributions varied widely both between and within eligible and ineligible counties and, as the association between age and mortality is generally nonlinear and discontinuous (e.g. 64 year olds have dramatically higher risk of death than do 18 year olds), these differences may lead to a violation of the exclusion restriction even with balance on raw percentages of elderly residents. To accomodate for this possibility, I used cause-specific crude rates and county-level population estimates for each 10-year age stratum to standardize cause-specific rates to the 2000 U.S. standard million (Anderson & Rosenberg, 1998), creating an additional outcome measure that was comparable across counties with different age distributions. $\newline$

*Model Specification and Estimation*

 To recover the regression discontinuity effect $\tau$ of county NHSC participation $D_i$ on 2015 mortality rate $Y_i$, I use a fuzzy regression discontinuity design and estimate $\tau$ with a two-stage least squares approach where $D$ is instrumented by $Z$. I allow for possible heterogeneity in the treatment effect as a function of $X_i$ by including interaction terms between the zero-centered transformation of $X_i$ ($\tilde{X_i}$) and eligibility $Z_i$. The models for the first stages are represented by equations 1 and 2, where $f_1(\tilde{X_i})$ is a given polynomial transformation of the centered running variable. 
$$
\begin{aligned}
D_i = \alpha_i + \gamma_0Z_i + \gamma_1(f_1(\tilde{X_i})) + \epsilon_i\text{ (1)}\\
f_1(\tilde{X_i})D_i = \alpha_i + \gamma_2Z_i + \gamma_3(f_1(\tilde{X_i}))Z_i + \epsilon_i\text{ (2)}
\end{aligned}
$$
  The second stage is estimated by equation 3, where $\hat{D_i}$ represents the fitted values of equation 1, and the various functions of $\tilde{X_i}\hat{D_i}$ represents fitted values from various functional forms of equation 2, with $f_1(\tilde{X_i}) = \tilde{X_i}^p$.
  
$$
\begin{aligned}
Y_i = \alpha + \tau\hat{D_i} + \beta_0\tilde{X_i}+ \beta_1(\tilde{X_i}\hat{D_i}) + ...\beta_p(\tilde{X_i}^p\hat{D_i}) +\mu_i\text{ (3)}
\end{aligned}
$$

To determine the appropriate functional form of the regression, I estimate $\tau$ using both the full sample with first, second and third order polynomials (i.e. where a $f_1(\tilde{X_i}) = \tilde{X_i};\tilde{X_i}^2; \tilde{X_i}^3$), and with local linear regression using a triangular kernel and observations within the robust bias-corrected (RBC) bandwidth (Calonico, Cattaneo, and Farrell, 2019).^[An aside regarding weights and clustering: Though counties do differ substantially in population, weighting for size would typically achieve an effect estimate appropriate for individual, rather than population inference. Additionally, although there is clear geographic clustering (e.g. counties within states), treatment (score) is not randomized at this level. Further, some clusters (namely, Delaware and Rhode Island) contain only two participating counties, leading not only to highly imbalanced cluster sizes and a substantial reduction in power.] $\newline$


*Sensitivity Analyses*

  I perform placebo tests using a range of false cutoff values of $X_i$ to estimate local average treatment effects at different points along the running variable. To assess balance in covariates around the cutoff, I estimate the LATE of program participation on 2014 percent poverty, percent of population over age 65, county-level median household income, percentage of residents who live in rural areas and who are White, Black, or Hispanic, and rates of unemployment, high school graduation, uninsurance, obesity, smoking, and insufficient physical activity using the same model specifications as above. As a final robustness check, I assess the effect of 2014 NHSC participation on placebo outcomes of 1999, 2005, and 2009 age-standardized mortality rates. $\newline$
 
## Results

*Descriptive Statistics*

A total of 851 counties were eligible for the NHSC in 2014, 406 (47.7%) of which ultimately received a physician recruit. In general, even restricting to counties within the median estimated RBC bandwidth, eligible counties differed significantly from ineligible counties by simple difference-in-means. On average, counties with IMU scores below the cutoff were less populous, had greater percentages of residents living in rural areas, lower percentages of non-Hispanic White residents, and performed worse on socioeconomic and health indicators, although in most instances differences were slight (Table 2). The density of observations just above and below the cutoff was continuous, showing no evidence of manipulation of the running variable (Figure 1; *p*_density = 0.68). Table 3 confirms that $Z$ and interactions between $Z$ and $X$ were strong instruments (all $F$ > 340, $p$ < 0.001). $\newline$

*Regression Discontinuity Effect*

Table 4 depicts the estimated effects of participating in the NHSC program on county-level age-standardized and crude mortality rates. Virtually all estimated coefficients were positive, indicating that participation in the NHSC increased mortality rates, and, in general, estimates derived using the full sample indicated a stronger effect of program participation than did local estimations. Similarly, the absolute effect of program participation was larger for all-cause mortality than for disease-specific mortality, with the largest estimated effect being an absolute [i.e. crude] increase of 359 deaths per 10,000 person-years (95% CI = 317.53 - 401.39) in treated counties near the cutoff versus similarly scored untreated counties. However, particularly for local estimators with RBC confidence intervals, most estimates were imprecise and non-significant.  Age-standardization improved precision somewhat, such that even after bias correction some estimates indicated statistically significant increases. With the exception of crude all-cause mortality rate, the magnitude and direction of effects were robust against alternate polynomial specifications. $\newline$

*Robustness to Various Bandwidth Selections*

Based on graphical inspection of regression plots (Figures 6-8, available in Supplement), quadratic specifications provided a better fit to the data than did linear specifications, while cubic specifications did not provide substantial improvement over quadratic models. In balancing parsimony and correct specification, I used local models including quadratic transformations of $X_i$ for further robustness checks.

For both age-standardized and crude all-cause mortality, the RBC estimate chosen at the optimal RBC bandwidth was contained in the 95% confidence intervals of estimated effects for both narrower and wider bandwidths (Figure 2). The magnitude of estimate effects was also relatively stable regardless of bandwidth selection, albeit with narrow bandwidths yielding an estimated effect approximately twice as large (an estimated excess 608 deaths per 10,000 person-years for NHSC participating counties) as that for the optimal bandwidth. Additionally, while the 95% confidence interval at the optimal bandwidth excluded the null for age-standardized rates, choosing a bandwith 1 point larger or smaller led to a widening of confidence intervals and inclusion of the null. Crude effects showed more sensitivity to choice of bandwidth, with point estimates including both positive and negative effects (Figure 2, bottom). In no case did crude RBC confidence intervals exclude the null.

Similar patterns occurred in both heart disease and cancer-specific mortality models (Figures 3 and 4). The positive estimated effects for age-standardized heart disease and cancer mortality were contained within the RBC 95% confidence interval for all alternative bandwidths excepting the narrowest (absolute distance of 4 points from the cutoff), after which estimated effects rose steeply. All regression discontinuity effects near the optimal bandwidth were nonsignificant but again indicated a higher mortality rate for treated counties. For crude rates, the effect of the NHSC on mortality were consistently null and small in magnitude. $\newline$


*Additional Sensitivity Analyses*

The of placebo fuzzy regression discontinuities assessing covariate balance and program participation on pretreatment outcomes suggested that participation in the NHSC was not associated with placebo outcomes (Table 5). Encouragingly for the known possible exogeneity violation by IMU score components, NHSC participation was not associated with either percent county residents below the federal poverty line ($\tau$ = -2.37, RBC 95% CI = -5.76 - 1.02) or percent of county residents age 65 or older ($\tau$ = 2.77, RBC 95% CI = -1.36 - 6.91). Placebo treatment effects for all sociodemographic characteristics were non-significant, although there was some indication that participating counties had higher uninsured rates ($\tau$ = 0.04, RBC 95% CI = - 0.01 - 0.08), smoking rates ($\tau$ = 0.06, RBC 95% CI = -0.02 - 0.13), and lower percentages of non-Hispanic White residents ($\tau$ = -0.09, RBC 95% CI = -0.28 - 0.10).

However, the local effects of 2014 NHSC participation on pretreatment mortality rates were significant in several instances, namely, for 1999 age-standardized all cause mortality ($\tau$ = 119.04, RBC 95% CI = 5.29 - 232.8) and 2009 age-standardized cancer mortality rate ($\tau$ = 89.28, 95% CI = 10.23 - 85.08).

$\newline$

*Limitations*
Nonetheless, there were a number of limitations which may have impacted results, the most prominent being a lack of data on IMU scores themselves. Identification in regression discontinuity is dependent upon *a priori* knowledge of treatment assignment according to, as well as consistent measurement of, the running variable. Though the data sources and scoring mechanism I used to regenerate the IMU are purportedly the same as those employed by the Department of Health and Human Services in designating underserved areas and all counties simulated as ineligible were in fact ineligible it is probable that measurement error occurred.^[Apparently, a lack of published IMU scores has posed a barrier to researchers other than the author. In early fall of 2019, a Freedom Of Information Act request was posed to the Department of Health and Human Services (DHHS) to release historic scores, to which DHHS has yet to respond.] Second, the estimand may have limited external validity. I exploit the change in eligibility ruling in 2014 for identification, but it possible that cumulative effects of the program may be more beneficial than those from its early implementation. For instance, new rulings are often accompanied by administrative difficulties and consume additional time and resources which may have negatively affected program implementation. The estimand also refers only to counties near the cutoff which actually receive a physician, which may be of less interest to counties that are more highly underserved.^[If the effect had indicated benefit, one might argue that the benefit applies only to compliers, so there would be a question of net positive. Such an argument doesn't necessarily apply in this case, where substantial harm may be done.]

```{r, echo = F, results='asis', warning = FALSE, message=FALSE}
#make a table one to show weighted scoring criteria
pcp_score <- c(0.05, .1, .15, .2, .25, .3, .35, .4, .45, .5, .55, .6, .65,
               .7, .75, .8, .85, .9, .95, 1, 1.05, 1.1, 1.15, 1.2, 1.25, 1.26)


weight_pcp <- function(x){
  if(is.na(x)){
    return(NA)
  }else if (x <= 0.05){
    return(0)
  } else if (x <= .1){
    return(0.5)
  } else if (x <= .15){
    return(1.5)
  } else if (x <= .2){
    return(2.8)
  } else if (x <= .25){
    return(4.1)
  } else if (x <= .3){
    return(5.7)
  } else if (x <= .35){
    return(7.3)
  } else if (x <= .4){
    return(9.0)
  } else if (x <= .45){
    return(10.7)
  } else if (x <= .5){
    return(12.6)
  } else if (x <= .55){
    return(14.8)
  } else if (x <= .6){
    return(16.9)
  } else if (x <= .65){
    return(19.1)
  } else if (x <= .7){
    return(20.7)
  } else if (x <= .75){
    return(21.9)
  } else if (x <= .8){
    return(23.1)
  }else if (x <= .85){
    return(24.3)
  }else if (x <= .90){
    return(25.3)
  }else if (x <= .95){
    return(25.9)
  }else if (x <= 1){
    return(26.6)
  }else if (x <= 1.05){
    return(27.2)
  }else if (x <= 1.1){
    return(27.7)
  }else if (x <= 1.15){
    return(28)
  }else if (x <= 1.2){
    return(28.3)
  }else if (x <= 1.25){
    return(28.6)
  }else {
    return(28.7)
  }
  
}

pcp_weights <- sapply(X = pcp_score, FUN = weight_pcp, simplify = "vector")
pcp_score[26] <- ">1.25"

inf_score <- c(8:37, 39, 41, 43, 45)

#classify the infant mortality
recodeInf <- function(x) {
  ifelse(is.na(x), NA,
         ifelse(x <= 8, 26,
                ifelse(x <= 9, 25.6,
                       ifelse(
                         x <= 10, 24.8,
                         ifelse(x <= 11, 24,
                                ifelse(
                                  x <= 12, 23.2,
                                  ifelse(x <= 13, 22.4,
                                         ifelse(
                                           x <= 14, 20.5,
                                           ifelse(x <= 15, 20.5,
                                                  ifelse(
                                                    x <= 16, 19.5,
                                                    ifelse(x <=
                                                             17, 18.5,
                                                           ifelse(
                                                             x <= 18, 17.5,
                                                             ifelse(x <=
                                                                      19, 16.4,
                                                                    ifelse(
                                                                      x <= 20, 15.3,
                                                                      ifelse(x <=
                                                                               21, 14.2,
                                                                             ifelse(
                                                                               x <= 22, 13.1,
                                                                               ifelse(x <=
                                                                                        23, 11.9,
                                                                                      ifelse(x <=
                                                                                               24, 10.8,
                                                                                             ifelse(
                                                                                               x <= 25, 9.6,
                                                                                               ifelse(x <=
                                                                                                        26, 8.5,
                                                                                                      ifelse(x <=
                                                                                                               27, 7.3,
                                                                                                             ifelse(
                                                                                                               x <= 28, 6.1,
                                                                                                               ifelse(x <=
                                                                                                                        29, 5.4,
                                                                                                                      ifelse(x <=
                                                                                                                               30, 5,
                                                                                                                             ifelse(
                                                                                                                               x <= 31, 4.7,
                                                                                                                               ifelse(x <=
                                                                                                                                        32, 4.3,
                                                                                                                                      ifelse(x <=
                                                                                                                                               33, 4,
                                                                                                                                             ifelse(
                                                                                                                                               x <= 34, 3.6,
                                                                                                                                               ifelse(x <=
                                                                                                                                                        35, 3.3,
                                                                                                                                                      ifelse(x <=
                                                                                                                                                               36, 3,
                                                                                                                                                             ifelse(
                                                                                                                                                               x <= 37, 2.6,
                                                                                                                                                               ifelse(x <=
                                                                                                                                                                        39, 2.0,
                                                                                                                                                                      ifelse(x <=
                                                                                                                                                                               41, 1.4,
                                                                                                                                                                             ifelse(
                                                                                                                                                                               x <= 43, 0.8,
                                                                                                                                                                               ifelse(x <= 45, 0.2, 0)
                                                                                                                                                                             )))
                                                                                                                                                             )))
                                                                                                                                             )))
                                                                                                                             )))
                                                                                                             )))
                                                                                             )))
                                                                             ))
                                                                    ))
                                                           ))
                                                  ))
                                         ))
                                ))
                       ))))
}

inf_weights <- recodeInf(inf_score)

old_score <- c(7:31)
#recode the over 65 vars
oldRecode <- function(x){
  ifelse(is.na(x), NA,
         ifelse(x<=7, 20.2,
                ifelse(x<=8, 20.1,
                       ifelse(x<=9, 19.9,
                              ifelse(x<=10, 19.8,
                                     ifelse(x<=11, 19.6,
                                            ifelse(x<=12, 19.4,
                                                   ifelse(x<=13, 19.1,
                                                          ifelse(x<=14, 18.9,
                                                                 ifelse(x<=15, 18.7,
                                                                        ifelse(x<=16, 17.8,
                                                                               ifelse(x<=17, 16.1,
                                                                                      ifelse(x<=18, 14.4,
                                                                                             ifelse(x<=19, 12.8,
                                                                                                    ifelse(x<=20, 11.2,
                                                                                                           ifelse(x<=21, 9.8,
                                                                                                                  ifelse(x<=22, 8.9,
                                                                                                                         ifelse(x<=23, 8,
                                                                                                                                ifelse(x<=24,7,
                                                                                                                                       ifelse(x<=25, 6.1,
                                                                                                                                              ifelse(x<=26, 5.1,
                                                                                                                                                     ifelse(x<=27, 4,
                                                                                                                                                            ifelse(x<=28, 2.8,
                                                                                                                                                                   ifelse(x<=29, 1.7,
                                                                                                                                                                          ifelse(x<=30, 0.6,0)))))))))))))))))))))))))
  
  
  
}

old_weights <- oldRecode(old_score)
old_score[25] <- ">30"

pov_score <- c(.1, 1, seq(4, 50, 2))
#poverty recode for IMU
povRecode <- function(x){
  return(
    ifelse(is.na(x), NA,
           ifelse(x <= .1, 25.1,
                  ifelse(x <= 1, 24.6,
                         ifelse(x <= 4, 23.7,
                                ifelse(x <= 6, 22.8,
                                       ifelse(x<=8, 21.9,
                                              ifelse(x<=10, 21,
                                                     ifelse(x<=12, 20,
                                                            ifelse(x<=14, 18.7,
                                                                   ifelse(x<=16, 17.4,
                                                                          ifelse(x<=18, 16.2,
                                                                                 ifelse(x<=20, 14.9,
                                                                                        ifelse(x<=22, 13.6,
                                                                                               ifelse(x<=24, 12.2,
                                                                                                      ifelse(x<=26, 10.9,
                                                                                                             ifelse(x<=28, 9.3,
                                                                                                                    ifelse(x<=30, 7.8,
                                                                                                                           ifelse(x<=32, 6.6,
                                                                                                                                  ifelse(x<=34, 5.6,
                                                                                                                                         ifelse(x<=36, 4.7,
                                                                                                                                                ifelse(x<=38, 3.4,
                                                                                                                                                       ifelse(x<=40, 2.1,
                                                                                                                                                              ifelse(x<=42, 1.3,
                                                                                                                                                                     ifelse(x<=44, 1,
                                                                                                                                                                            ifelse(x<=46, 0.7,
                                                                                                                                                                                   ifelse(x<=48, 0.4,
                                                                                                                                                                                          ifelse(x<=50, 0.1, 0)))))))))))))))))))))))))))
  )
}

pov_weights <- povRecode(pov_score)

tab1 <- cbind(inf_score, inf_weights, c(old_score, rep("--",9)), 
              c(old_weights, rep("--",9)),
              c(pcp_score, rep("--",8)), c(pcp_weights, rep("--",8)),
              c(pov_score, rep("--",8)), c(pov_weights, rep("--",8)))
tab1[26,7] <- "50 +"
tab1 <- as.data.frame(tab1)
names(tab1) <- c("Infant Mortality Rate", "Infant Mortality Score",
                 "Percent Population Over 65", "Over 65 Score",
                 "Primary Care to Population Ratio", "Primary Care Ratio Score",
                 "Percent Population in Poverty", "Poverty Score")

tab1[,c(1,3,5,7)] <- sapply(tab1[,c(1,3,5,7)], function(x) paste0("\u2264", x), USE.NAMES=FALSE)

tab1[,c(1,3,5,7)] <- sapply(tab1[,c(1,3,5,7)], function(x) ifelse(str_detect(x, "--"), "--",x))
tab1[,c(1,3,5,7)] <- sapply(tab1[,c(1,3,5,7)], function(x) str_replace(x, pattern ="\u2264", replacement = "<= "), USE.NAMES=FALSE)
tab1[25,3] <- ">30"
tab1[26,5] <- ">1.25"
tab1[26,7] <- ">48"
tab1[34,1] <- ">43"

tab1$`Infant Mortality Score` <- ifelse(nchar(as.character(tab1$`Infant Mortality Score`))<3,
                                        paste0(as.character(tab1$`Infant Mortality Score`), ".0"),
                                        as.character(tab1$`Infant Mortality Score`))

tab1$`Over 65 Score` <- ifelse(nchar(as.character(tab1$`Over 65 Score`))<3 &
                                 !str_detect(as.character(tab1$`Over 65 Score`), "--"),
                                        paste0(as.character(tab1$`Over 65 Score`), ".0"),
                                        as.character(tab1$`Over 65 Score`))

tab1$`Primary Care Ratio Score` <- ifelse(nchar(as.character(tab1$`Primary Care Ratio Score`))<3 &
                                 !str_detect(as.character(tab1$`Primary Care Ratio Score`), "--"),
                               paste0(as.character(tab1$`Primary Care Ratio Score`), ".0"),
                               as.character(tab1$`Primary Care Ratio Score`))

tab1$`Poverty Score` <- ifelse(nchar(as.character(tab1$`Poverty Score`))<3 &
                                 !str_detect(as.character(tab1$`Poverty Score`), "--"),
                               paste0(as.character(tab1$`Poverty Score`), ".0"),
                               as.character(tab1$`Poverty Score`))




names(tab1) <- c(rep(c("Value", "Score"),4))
tab1 %>% kableExtra::kable("latex",booktabs = T, escape = TRUE, align = "r",
                           caption = "Description of index of medical underservice score subcomponents and weighting") %>%
  # here you can add the vertical line, in my example, for all the columns
  kableExtra::column_spec (1:7) %>%
  kableExtra::kable_styling("latex")%>%
  add_header_above(c("Infant Mortality" = 2, "Percent  Over 65" = 2,
                     "Primary Care Ratio" = 2, "Percent  in Poverty" = 2))%>%
  footnote(number = c("Infant Mortality Rate = Infant Deaths per 1000 Live Births",
                      "PCP Ratio = Total FTE Non-federal Primary Care Providers per 1000 Population",
                      "Poverty = At or Below Federal Poverty Level"))
  
```


```{r}

merge.mortb <- read_csv("C:\\Users\\Owner\\OneDrive\\Documents\\Spring2020\\imu_data\\data\\final_IMU_analysis_data.csv")
merge.mortb <- janitor::clean_names(merge.mortb)
merge.mortb <- merge.mortb[!(merge.mortb$treatment == 1 & merge.mortb$newimu14 > 62),]


col1 <- c("620", "290 (47.90)", "0.17 (0.03)", "0.13 (0.05)", "25.67 (1.70)", "0.81 (0.57)",
          "29,304 (55,339)","0.75 (0.24)","0.76 (0.20)","0.12 (0.17)","0.08 (0.14)",
          "0.24 (0.06)","0.33 (0.04)","0.30 (0.05)","0.16 (0.04)")
col2 <- c("690","0 (0.00)","0.14 (0.05)","0.14 (0.05)","24.76 (0.74)","1.36 (0.60)",
        "54,822 (129,421)","0.60 (0.26)","0.81 (0.18)","0.07 (0.11)",
          "0.09 (0.14)","0.22 (0.06)","0.32 (0.04)","0.26 (0.04)","0.14 (0.04)")
col3 <- c("--", "--", rep( "< 0.001",8), "0.001", rep("< 0.001",4))

tab2 <- cbind.data.frame(col1, col2, col3)
names(tab2) <- c("IMU > 51.88 and <= 62",	"IMU > 62 and <= 72.11",	"P-value")
rownames(tab2) <- c("N", "Enrolled in NHSC",  "Poverty\\textsuperscript{1}","Older Than 65 Years", "Infant Health Index\\textsuperscript{2}",  "Primary Care Ratio\\textsuperscript{3}",	 "Total Population" ,"Rural", "Non-Hispanic White",	"Non-Hispanic Black",   "Hispanic",	"Current Smokers"	, "Obese"	, "Physically Inactive" ,"Uninsured")

tab2 %>%
  kable("latex", align =c("c", "c", "r"), 
        booktabs = TRUE, caption = "Sample characteristics of counties with Index of Medical Underservice (IMU) scores within the median RBC bandwidth. All characteristics are based on 2014 data or, for IMU components, the five-year average of 2009-2014 data and are shown as Mean (SD). Except for total population, infant health index, and primary care ratio, all values represent proportions of county residents with given characteristic.", escape = FALSE) %>%
  group_rows(start_row = 1, end_row = 2) %>%
  group_rows(start_row = 3, end_row = 6, group_label = "IMU Components") %>%
  group_rows(start_row = 7, end_row = 11, group_label = "County Characteristics") %>%
  group_rows(start_row = 12, end_row = 15, group_label = "Health Indicators")%>%
  footnote(number = c("Poverty = At or Below Federal Poverty Level",
  "Infant Mortality Rate = Infant Deaths per 1000 Live Births",
                      "PCP Ratio = Total FTE Non-federal Primary Care Providers per 1000 Population"
                      ))


```


```{r, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}
library(AER)
merge.mortb$eligible <- merge.mortb$newimu14 <=62
merge.mortb$x_tilde <- merge.mortb$newimu14 - 62

iv.ac1 <- ivreg(age_adjusted_rate_2015a ~ treatment| x_tilde*eligible, data = merge.mortb)
s1 <- summary(iv.ac1, diagnostics = TRUE)

iv.ac2 <- ivreg(age_adjusted_rate_2015a ~ treatment| I(x_tilde^2)*eligible + 
                  x_tilde*eligible, data = merge.mortb)
s2<- summary(iv.ac2, diagnostics = TRUE)
iv.ac3 <- ivreg(age_adjusted_rate_2015a ~ treatment| I(x_tilde^2)*eligible + I(x_tilde^3)*eligible+
                  x_tilde*eligible, data = merge.mortb)
s3 <- summary(iv.ac3, diagnostics = TRUE)


iv.hd1 <- ivreg(age_adjusted_rate_2015h ~ treatment| x_tilde*eligible, data = merge.mortb)
s4 <- summary(iv.ac1, diagnostics = TRUE)
iv.hd2 <- ivreg(age_adjusted_rate_2015h ~ treatment| I(x_tilde^2)*eligible + 
                  x_tilde*eligible, data = merge.mortb)
s5 <- summary(iv.hd2, diagnostics = TRUE)
iv.hd3 <- ivreg(age_adjusted_rate_2015h ~ treatment| I(x_tilde^2)*eligible + I(x_tilde^3)*eligible+
                  x_tilde*eligible, data = merge.mortb)
s6 <- summary(iv.hd3, diagnostics = TRUE)


iv.ca1 <- ivreg(age_adjusted_rate_2015c ~ treatment| x_tilde*eligible, data = merge.mortb)
s7 <- summary(iv.ca1, diagnostics = TRUE)
iv.ca2 <- ivreg(age_adjusted_rate_2015c ~ treatment| I(x_tilde^2)*eligible + 
                  x_tilde*eligible, data = merge.mortb)
s8 <- summary(iv.ca2, diagnostics = TRUE)
iv.ca3 <- ivreg(age_adjusted_rate_2015c ~ treatment| I(x_tilde^2)*eligible + I(x_tilde^3)*eligible+
                  x_tilde*eligible, data = merge.mortb)
s9 <- summary(iv.ca3, diagnostics = TRUE)

######################################
#crude
iv.c.ac1 <- ivreg(crude_rate_2015a ~ treatment| x_tilde*eligible, data = merge.mortb)
s10 <- summary(iv.c.ac1, diagnostics = TRUE)
iv.c.ac2 <- ivreg(crude_rate_2015a ~ treatment| I(x_tilde^2)*eligible + 
                  x_tilde*eligible, data = merge.mortb)
s11 <- summary(iv.c.ac2, diagnostics = TRUE)
iv.c.ac3 <- ivreg(crude_rate_2015a ~ treatment| I(x_tilde^2)*eligible + I(x_tilde^3)*eligible+
                  x_tilde*eligible, data = merge.mortb)
s12 <- summary(iv.c.ac3, diagnostics = TRUE)


iv.c.hd1 <- ivreg(crude_rate_2015h ~ treatment| x_tilde*eligible, data = merge.mortb)
s13 <- summary(iv.c.ac1, diagnostics = TRUE)
iv.c.hd2 <- ivreg(crude_rate_2015h ~ treatment| I(x_tilde^2)*eligible + 
                  x_tilde*eligible, data = merge.mortb)
s14 <- summary(iv.c.hd2, diagnostics = TRUE)
iv.c.hd3 <- ivreg(crude_rate_2015h ~ treatment| I(x_tilde^2)*eligible + I(x_tilde^3)*eligible+
                  x_tilde*eligible, data = merge.mortb)
s15 <- summary(iv.c.hd3, diagnostics = TRUE)


iv.c.ca1 <- ivreg(crude_rate_2015c ~ treatment| x_tilde*eligible, data = merge.mortb)
s16 <- summary(iv.c.ca1, diagnostics = TRUE)
iv.c.ca2 <- ivreg(crude_rate_2015c ~ treatment| I(x_tilde^2)*eligible + 
                  x_tilde*eligible, data = merge.mortb)
s17<- summary(iv.c.ca2, diagnostics = TRUE)
iv.c.ca3 <- ivreg(crude_rate_2015c ~ treatment| I(x_tilde^2)*eligible + I(x_tilde^3)*eligible+
                  x_tilde*eligible, data = merge.mortb)
s18 <- summary(iv.c.ca3, diagnostics = TRUE)

```

```{r}
#table for weak instruments
weak.int <- cbind.data.frame(c("All-Cause Mortality", "All-Cause Mortality",
                     "Heart Disease Mortality","Heart Disease Mortality",
                     "Cancer Mortality","Cancer Mortality"),
                             rbind(s1$diagnostics[1,3:4],s10$diagnostics[1,3:4],
                                   s4$diagnostics[1,3:4],s13$diagnostics[1,3:4],
                                   s7$diagnostics[1,3:4],s16$diagnostics[1,3:4]),
                             rbind(s2$diagnostics[1,3:4],s11$diagnostics[1,3:4],
                                   s5$diagnostics[1,3:4],s14$diagnostics[1,3:4],
                                   s8$diagnostics[1,3:4],s17$diagnostics[1,3:4]),
                             rbind(s3$diagnostics[1,3:4],s12$diagnostics[1,3:4],
                                   s6$diagnostics[1,3:4],s15$diagnostics[1,3:4],
                                   s9$diagnostics[1,3:4],s18$diagnostics[1,3:4])
                             )
weak.int[weak.int == 0] <- "< 0.001"
weak.int <- weak.int[c(1,3,5),]
names(weak.int) <- c("Outcome","F-Statistic", "P-value", "F-Statistic", "P-value", "F-Statistic", "P-value")

weak.int %>%
  kableExtra::kable("latex", booktabs = T, escape = T, align = c(rep("r",6)),
                    caption = "Tests of Weak Instruments For IMU Scores and Eligibility")%>%
  add_header_above(c("Outcome"=1, "1st" = 2, "2nd" = 2, "3rd" = 2))%>%
  add_header_above(c("", "Polynomial Order"=6)) %>%
  footnote(general = "Test statistics differ slightly by outcome given missing data on heart disease and cancer mortality")

```


```{r, results = 'asis', echo = FALSE, message = FALSE, warning = FALSE}
#Write a function that will make a plot of the RDD using various bandwidths
#(including the IK bandwidth)
#also see flexibility of model specification usign iv approach given this is a fuzzy rd

set.seed(48104)
# RD Effect for main outcome variable  ==> Local linear polynomial estimation with optimal bandwidth
ac.a.1 <- rdrobust(merge.mortb$age_adjusted_rate_2015a, 
                merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                c = 0, all=TRUE,masspoints = F)
ac.a.2 <- rdrobust(merge.mortb$age_adjusted_rate_2015a, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 2,masspoints = F)
ac.a.3 <- rdrobust(merge.mortb$age_adjusted_rate_2015a, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 3,masspoints = F)
hd.a.1 <- rdrobust(merge.mortb$age_adjusted_rate_2015h, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE,masspoints = F)
hd.a.2 <- rdrobust(merge.mortb$age_adjusted_rate_2015h, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 2,masspoints = F)
hd.a.3 <- rdrobust(merge.mortb$age_adjusted_rate_2015h, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 3,masspoints = F)
ca.a.1 <- rdrobust(merge.mortb$age_adjusted_rate_2015c, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE,masspoints = F)
ca.a.2 <- rdrobust(merge.mortb$age_adjusted_rate_2015c, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 2,masspoints = F)
ca.a.3 <- rdrobust(merge.mortb$age_adjusted_rate_2015c, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 3,masspoints = F)

ac.c.1 <- rdrobust(merge.mortb$crude_rate_2015a, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE,masspoints = F)
ac.c.2 <- rdrobust(merge.mortb$crude_rate_2015a, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 2,masspoints = F)
ac.c.3 <- rdrobust(merge.mortb$crude_rate_2015a, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 3,masspoints = F)
hd.c.1 <- rdrobust(merge.mortb$crude_rate_2015h, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE,masspoints = F)
hd.c.2 <- rdrobust(merge.mortb$crude_rate_2015h, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 2,masspoints = F)
hd.c.3 <- rdrobust(merge.mortb$crude_rate_2015h, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 3,masspoints = F)
ca.c.1 <- rdrobust(merge.mortb$crude_rate_2015c, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE,masspoints = F)
ca.c.2 <- rdrobust(merge.mortb$crude_rate_2015c, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 2,masspoints = F)
ca.c.3 <- rdrobust(merge.mortb$crude_rate_2015c, 
                   merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                   c = 0, all=TRUE, p = 3,masspoints = F)


#create a nice table of results
outcome <- c(rep(c(rep("All Cause",3), rep("Heart Disease", 3), rep("Cancer", 3)), 2))

polys <- c(rep(1:3,6))

bandwidths <- c(ac.a.1$bws[1,1], ac.a.2$bws[1,1], ac.a.3$bws[1,1],
                hd.a.1$bws[1,1], hd.a.2$bws[1,1], hd.a.3$bws[1,1],
                ca.a.1$bws[1,1], ca.a.2$bws[1,1], ca.a.3$bws[1,1],
                ac.c.1$bws[1,1], ac.c.2$bws[1,1], ac.c.3$bws[1,1],
                hd.c.1$bws[1,1], hd.c.2$bws[1,1], hd.c.3$bws[1,1],
                ca.c.1$bws[1,1], ca.c.2$bws[1,1], ca.c.3$bws[1,1])

tau.rdd <- c(ac.a.1$Estimate[2], ac.a.2$Estimate[2], ac.a.3$Estimate[2],
             hd.a.1$Estimate[2], hd.a.2$Estimate[2], hd.a.3$Estimate[2],
             ca.a.1$Estimate[2], ca.a.2$Estimate[2], ca.a.3$Estimate[2],
             ac.c.1$Estimate[2], ac.c.2$Estimate[2], ac.c.3$Estimate[2],
             hd.c.1$Estimate[2], hd.c.2$Estimate[2], hd.c.3$Estimate[2],
             ca.c.1$Estimate[2], ca.c.2$Estimate[2], ca.c.3$Estimate[2])

iv.rdd <- c(sprintf("%.2f",round(iv.ac1$coefficients[2],2)),
            sprintf("%.2f",round(iv.ac2$coefficients[2],2)),
            sprintf("%.2f",round(iv.ac3$coefficients[2],2)),
            sprintf("%.2f",round(iv.hd1$coefficients[2],2)),
            sprintf("%.2f",round(iv.hd2$coefficients[2],2)),
            sprintf("%.2f",round(iv.hd3$coefficients[2],2)),
            sprintf("%.2f",round(iv.ca1$coefficients[2],2)),
            sprintf("%.2f",round(iv.ca2$coefficients[2],2)),
            sprintf("%.2f",round(iv.ca3$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.ac1$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.ac2$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.ac3$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.hd1$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.hd2$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.hd3$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.ca1$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.ca2$coefficients[2],2)),
            sprintf("%.2f",round(iv.c.ca3$coefficients[2],2)))

iv.ci <- c(paste0(sprintf("%.2f", round(confint(iv.ac1)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.ac1)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.ac2)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.ac2)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.ac3)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.ac3)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.hd1)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.hd1)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.hd2)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.hd2)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.hd3)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.hd3)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.ca1)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.ca1)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.ca2)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.ca2)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.ca3)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.ca3)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.ac1)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.ac1)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.ac2)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.ac2)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.ac3)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.ac3)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.hd1)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.hd1)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.hd2)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.hd2)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.hd3)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.hd3)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.ca1)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.ca1)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.ca2)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.ca2)[2,2],2))),
       paste0(sprintf("%.2f", round(confint(iv.c.ca3)[2,1],2))," - ",
       sprintf("%.2f", round(confint(iv.c.ca3)[2,2],2)))
       )

ci.conv <- c(paste0(round(ac.a.1$Estimate[2]- 1.96*ac.a.1$se[1],2), " - ", round(ac.a.1$Estimate[2]+ 1.96*ac.a.1$se[1],2)),
             paste0(round(ac.a.2$Estimate[2]- 1.96*ac.a.2$se[1],2), " - ", round(ac.a.2$Estimate[2]+ 1.96*ac.a.2$se[1],2)),
             paste0(round(ac.a.3$Estimate[2]- 1.96*ac.a.1$se[1],2), " - ", round(ac.a.3$Estimate[2]+ 1.96*ac.a.1$se[1],2)),
             paste0(round(hd.a.1$Estimate[2]- 1.96*hd.a.1$se[1],2), " - ", round(hd.a.1$Estimate[2]+ 1.96*hd.a.1$se[1],2)),
             paste0(round(hd.a.2$Estimate[2]- 1.96*hd.a.2$se[1],2), " - ", round(hd.a.2$Estimate[2]+ 1.96*hd.a.2$se[1],2)),
             paste0(round(hd.a.3$Estimate[2]- 1.96*hd.a.1$se[1],2), " - ", round(hd.a.3$Estimate[2]+ 1.96*hd.a.1$se[1],2)),
             paste0(round(ca.a.1$Estimate[2]- 1.96*ca.a.1$se[1],2), " - ", round(ca.a.1$Estimate[2]+ 1.96*ca.a.1$se[1],2)),
             paste0(round(ca.a.2$Estimate[2]- 1.96*ca.a.2$se[1],2), " - ", round(ca.a.2$Estimate[2]+ 1.96*ca.a.2$se[1],2)),
             paste0(round(ca.a.3$Estimate[2]- 1.96*ca.a.1$se[1],2), " - ", round(ca.a.3$Estimate[2]+ 1.96*ca.a.1$se[1],2)),
             paste0(round(ac.c.1$Estimate[2]- 1.96*ac.c.1$se[1],2), " - ", round(ac.c.1$Estimate[2]+ 1.96*ac.c.1$se[1],2)),
             paste0(round(ac.c.2$Estimate[2]- 1.96*ac.c.2$se[1],2), " - ", round(ac.c.2$Estimate[2]+ 1.96*ac.c.2$se[1],2)),
             paste0(round(ac.c.3$Estimate[2]- 1.96*ac.c.1$se[1],2), " - ", round(ac.c.3$Estimate[2]+ 1.96*ac.c.1$se[1],2)),
             paste0(round(hd.c.1$Estimate[2]- 1.96*hd.c.1$se[1],2), " - ", round(hd.c.1$Estimate[2]+ 1.96*hd.c.1$se[1],2)),
             paste0(round(hd.c.2$Estimate[2]- 1.96*hd.c.2$se[1],2), " - ", round(hd.c.2$Estimate[2]+ 1.96*hd.c.2$se[1],2)),
             paste0(round(hd.c.3$Estimate[2]- 1.96*hd.c.1$se[1],2), " - ", round(hd.c.3$Estimate[2]+ 1.96*hd.c.1$se[1],2)),
             paste0(round(ca.c.1$Estimate[2]- 1.96*ca.c.1$se[1],2), " - ", round(ca.c.1$Estimate[2]+ 1.96*ca.c.1$se[1],2)),
             paste0(round(ca.c.2$Estimate[2]- 1.96*ca.c.2$se[1],2), " - ", round(ca.c.2$Estimate[2]+ 1.96*ca.c.2$se[1],2)),
             paste0(round(ca.c.3$Estimate[2]- 1.96*ca.c.1$se[1],2), " - ", round(ca.c.3$Estimate[2]+ 1.96*ca.c.1$se[1],2)))


ci.robu <- c(paste0(round(ac.a.1$Estimate[2]- 1.96*ac.a.1$se[3],2), " - ", round(ac.a.1$Estimate[2]+ 1.96*ac.a.1$se[3],2)),
             paste0(round(ac.a.2$Estimate[2]- 1.96*ac.a.2$se[3],2), " - ", round(ac.a.2$Estimate[2]+ 1.96*ac.a.2$se[3],2)),
             paste0(round(ac.a.3$Estimate[2]- 1.96*ac.a.1$se[3],2), " - ", round(ac.a.3$Estimate[2]+ 1.96*ac.a.1$se[3],2)),
             paste0(round(hd.a.1$Estimate[2]- 1.96*hd.a.1$se[3],2), " - ", round(hd.a.1$Estimate[2]+ 1.96*hd.a.1$se[3],2)),
             paste0(round(hd.a.2$Estimate[2]- 1.96*hd.a.2$se[3],2), " - ", round(hd.a.2$Estimate[2]+ 1.96*hd.a.2$se[3],2)),
             paste0(round(hd.a.3$Estimate[2]- 1.96*hd.a.1$se[3],2), " - ", round(hd.a.3$Estimate[2]+ 1.96*hd.a.1$se[3],2)),
             paste0(round(ca.a.1$Estimate[2]- 1.96*ca.a.1$se[3],2), " - ", round(ca.a.1$Estimate[2]+ 1.96*ca.a.1$se[3],2)),
             paste0(round(ca.a.2$Estimate[2]- 1.96*ca.a.2$se[3],2), " - ", round(ca.a.2$Estimate[2]+ 1.96*ca.a.2$se[3],2)),
             paste0(round(ca.a.3$Estimate[2]- 1.96*ca.a.1$se[3],2), " - ", round(ca.a.3$Estimate[2]+ 1.96*ca.a.1$se[3],2)),
             paste0(round(ac.c.1$Estimate[2]- 1.96*ac.c.1$se[3],2), " - ", round(ac.c.1$Estimate[2]+ 1.96*ac.c.1$se[3],2)),
             paste0(round(ac.c.2$Estimate[2]- 1.96*ac.c.2$se[3],2), " - ", round(ac.c.2$Estimate[2]+ 1.96*ac.c.2$se[3],2)),
             paste0(round(ac.c.3$Estimate[2]- 1.96*ac.c.1$se[3],2), " - ", round(ac.c.3$Estimate[2]+ 1.96*ac.c.1$se[3],2)),
             paste0(round(hd.c.1$Estimate[2]- 1.96*hd.c.1$se[3],2), " - ", round(hd.c.1$Estimate[2]+ 1.96*hd.c.1$se[3],2)),
             paste0(round(hd.c.2$Estimate[2]- 1.96*hd.c.2$se[3],2), " - ", round(hd.c.2$Estimate[2]+ 1.96*hd.c.2$se[3],2)),
             paste0(round(hd.c.3$Estimate[2]- 1.96*hd.c.1$se[3],2), " - ", round(hd.c.3$Estimate[2]+ 1.96*hd.c.1$se[3],2)),
             paste0(round(ca.c.1$Estimate[2]- 1.96*ca.c.1$se[3],2), " - ", round(ca.c.1$Estimate[2]+ 1.96*ca.c.1$se[3],2)),
             paste0(round(ca.c.2$Estimate[2]- 1.96*ca.c.2$se[3],2), " - ", round(ca.c.2$Estimate[2]+ 1.96*ca.c.2$se[3],2)),
             paste0(round(ca.c.3$Estimate[2]- 1.96*ca.c.1$se[3],2), " - ", round(ca.c.3$Estimate[2]+ 1.96*ca.c.1$se[3],2)))

#bind together for table
res.tab <- cbind.data.frame(outcome, polys, iv.rdd, iv.ci, bandwidths, tau.rdd, ci.conv, ci.robu)
res.tab$bandwidths <- round(res.tab$bandwidths, 2)
res.tab$tau.rdd <- round(res.tab$tau.rdd, 2)

names(res.tab) <- c("Outcome", "Order","estimate","conventional","BW", "Estimate", "Conventional", "Robust")

res.tab %>%
  #this will get labelled later
  mutate(Outcome = rep(c("All Cause", " ", " ",
                     "Heart Disease", " ", " ",
                     "Cancer", " ", " "),2)) %>%
  #specify which ones should be bold
  mutate(
     Conventional = cell_spec(Conventional, 
                              bold = ifelse(substr(Conventional,1,1)!= "-", T, F)),
     Robust = cell_spec(Robust, bold = ifelse(substr(Robust,1,1)!= "-", T, F))
     ,estimate= cell_spec(estimate, bold = ifelse(substr(conventional,1,1) != "-", T,F)),
     conventional = cell_spec(conventional, bold = ifelse(substr(conventional,1,1) != "-", T,F))
     ) %>%
  rename(` Estimate` = estimate,
         ` Conventional` = conventional)%>%
  kable("latex", booktabs = T, escape = F, align= c('l','r','r', 'r', 'r', 'r', 'r', 'r'),
        caption = "Effect of NHSC Participation on County-Level Mortality") %>%
  kable_styling(row_label_position = "l",) %>%
  add_header_above(c("", "", "", "95% CI","", "", "95% CI"=2)) %>%
  add_header_above(c(" ", " ","Full Sample" = 2, "Local" = 4)) %>%
  group_rows(start_row = 1, end_row= 9, group_label = "Age Adjusted Rate") %>%
  group_rows(start_row = 10, end_row = 18, group_label = "Crude Rate") %>%
  footnote(general = "Estimates represent tau FRD estimated using either IV or a local regression with a triangular kernel")%>%
  add_footnote(label = "Bold face denotes statistical significance (p < 0.05)")

```

```{r, fig.cap='McCrary Density Test shows no evidence of sorting at the cutoff (p = 0.68)', results='hide', fig.pos = 'h'}
`Transformed IMU Score 2014`<- merge.mortb$imu14 -62
rddapp::dc_test(`Transformed IMU Score 2014`, 0, bw = 10.11)

```

```{r}
#figure showing sensitivity to bw choice

make_rdd_plot_data <- function(outcome, cut = merge.mortb$x_tilde, covars = NULL){
  rd1 <-rdrobust(y = outcome, 
                x = cut, fuzzy = merge.mortb$treatment,
                c = 0, all=TRUE , masspoints = F, p = 2)

  tempframe <- cbind.data.frame(c(1:24, rd1$bws[1,1]),
                                c(rep(0,24), rd1$Estimate[2]),
                                c(rep(0,24), rd1$Estimate[1]),
                                c(rep(0,24),rd1$ci[2,2]), 
                                c(rep(0,24),rd1$ci[2,1]),
                                c(rep(0,24),rd1$ci[3,2]),
                                c(rep(0,24),rd1$ci[3,1]),
                                c(rep(0,24),sum(rd1$N_h)))

  names(tempframe) <- c("bw", "estimate_bc", "estimate_us", "upper_bc","lower_bc",
                         "upper_rob","lower_rob",
                         "nObs")
  

  for (i in 1:24){
    j <- tempframe[i,1]
      rd <- rdrobust(y = outcome, 
                x = cut, fuzzy = merge.mortb$treatment, h = j,
                c = 0, all=TRUE , masspoints = F, p = 2)
     tempframe[i,] <- c(j,
                       rd$Estimate[2],
                       rd$Estimate[1],
                       rd$ci[2,2], rd$ci[2,1],
                       rd$ci[3,2], rd$ci[3,1],
                       sum(rd$N_h))
  }
  
  
  return(tempframe)  
}

plot_rdd_data <- function(dat){
  int <- dat[25,1] #ik bw
  dat <- dat %>% filter(bw >= 2)
  ymin <- min(dat$lower_rob)
  ymax <- max(dat$upper_rob)
  dat %>%
    ggplot(aes(x = bw, y = estimate_bc)) + geom_point(color = "black") +
    geom_ribbon(aes(ymin = lower_rob, ymax = upper_rob), alpha =.3, fill = "#00BFC4") +
    geom_point(aes(x = bw, y = estimate_us), color = "#F8766D") + 
    geom_ribbon(aes(ymin = lower_bc, ymax = upper_bc), alpha =.3, fill = "#F8766D") +
    theme_bw() + labs(x = "Absolute Distance From Cutoff", y = "LATE")+
    geom_text(aes(label = paste(nObs)), nudge_y = 250, nudge_x = -.2,
              check_overlap = TRUE, angle = 60)+
    geom_vline(xintercept = int, linetype = "dashed", color = "darkgrey")+
    geom_hline(yintercept = 0, color = "black")+
    xlim(c(2,23))+ theme(panel.grid.minor.x = element_blank()) #+
    #ylim(c(ymin + 50 , ymax - 50))

}

plot_rdd_data2 <- function(dat){
  int <- dat[25,1] #ik bw
  dat <- dat %>% filter(bw >= 2)
  ymin <- min(dat$lower_rob)
  ymax <- max(dat$upper_rob)
  dat %>%
    ggplot(aes(x = bw, y = estimate_bc)) + geom_point(color = "black") +
    geom_ribbon(aes(ymin = lower_rob, ymax = upper_rob), alpha =.3, fill = "#00BFC4") +
    geom_point(aes(x = bw, y = estimate_us), color = "#F8766D") + 
    geom_ribbon(aes(ymin = lower_bc, ymax = upper_bc), alpha =.3, fill = "#F8766D") +
    theme_bw() + labs(x = "Absolute Distance From Cutoff", y = "LATE")+
    geom_text(aes(label = paste(nObs)), nudge_y = 50, nudge_x = -.2,
              check_overlap = TRUE, angle = 60)+
    geom_vline(xintercept = int, linetype = "dashed", color = "darkgrey")+
    geom_hline(yintercept = 0, color = "black")+
    xlim(c(2,23))+ theme(panel.grid.minor.x = element_blank()) #+
   # ylim(c(ymin + 50 , ymax - 50))

}

all.cause.age <- 
  make_rdd_plot_data(merge.mortb$age_adjusted_rate_2015a) %>%
  plot_rdd_data()

all.cause.crude <- 
  make_rdd_plot_data(merge.mortb$crude_rate_2015a) %>%
  plot_rdd_data()

heart.age <- 
  make_rdd_plot_data(merge.mortb$age_adjusted_rate_2015h) %>%
  plot_rdd_data()

heart.crude <- 
  make_rdd_plot_data(merge.mortb$crude_rate_2015h) %>%
  plot_rdd_data()

cancer.age <- 
  make_rdd_plot_data(merge.mortb$age_adjusted_rate_2015c) %>%
  plot_rdd_data2()

cancer.crude <- 
  make_rdd_plot_data(merge.mortb$crude_rate_2015c) %>%
  plot_rdd_data2()

```


```{r,fig.cap="Age-standardized (top) and crude (bottom) LATE estimates for all-cause mortality are robust against choice of bandwidth. LATE is estimated as a local fuzzy RDD with a triangular kernel and second-order polynomial. Dashed line indicates optimal RBC bandwidth, numbers reflect number of observations within a given bandwidth, black dots and blue ribbon represents robust bias-corrected estimate and 95% CI, and pink dots and grey ribbon represents conventional estimate and 95% CI", fig.height=10, fig.width=8}
library(patchwork)
all.cause.age / all.cause.crude + plot_annotation(title = "Effect of NHSC on All-Cause Mortality Rate")

```


```{r,fig.cap="Age-standardized (top) and crude(bottom) LATE estimates for heart disease mortality are relatively robust against choice of bandwidth. LATE is estimated as a local fuzzy RDD with a triangular kernel and second-order polynomial. Dashed line indicates optimal RBC bandwidth, numbers reflect number of observations within a given bandwidth, black dots and blue ribbon represents robust bias-corrected estimate and 95% CI, and pink dots and grey ribbon represents conventional estimate and 95% CI", fig.height=10, fig.width=8}
heart.age / heart.crude+ plot_annotation(title = "Effect of NHSC on Heart Disease Mortality Rate")

```


```{r,fig.cap="Age-standardized (top) and crude (bottom) LATE estimates for cancer mortality are robust against choice of bandwidth. LATE is estimated as a local fuzzy RDD with a triangular kernel and second-order polynomial. Dashed line indicates optimal RBC bandwidth, numbers reflect number of observations within a given bandwidth, black dots and blue ribbon represents robust bias-corrected estimate and 95% CI, and pink dots and grey ribbon represents conventional estimate and 95% CI", fig.height=10, fig.width=8}
cancer.age / cancer.crude+ plot_annotation(title = "Effect of NHSC on Cancer Mortality Rate")

```


## Supplementary Material and Sensitivity Analyses

```{r, fig.cap='Directed Acyclic Graph depicting causal model of NHSC program and county-level mortality', fig.height=6, fig.width=7, fig.align='center'}
library(DiagrammeR)
#make dag
grViz("
	digraph causal {
	
	  # Nodes
	  node [shape = plaintext]

	  D [label = 'Program\nParticipation']
	  Y [label = 'Mortality']
	  Z [label = 'Eligibility']
    X [label = 'IMU Score']
    x1 [label = 'Poverty']
    x2 [label = 'Elderly']
    x3 [label = 'Doctors']
    x4 [label = 'Infant Mortality']
    
	  
	  # Edges
	  edge [color = black,
	        arrowhead = vee]
	  rankdir = LR
	  D -> Y
	  Z -> D
	  X -> Z
	  x1 -> X
	  x2 -> X
	  x3 -> X
	  x4 -> X
	  x1 -> Y
	  x2 -> Y


	  # Graph
	  graph [overlap = true, fontsize = 25]
	}")
```


### FRDD Specifications
```{r}
#figure showing how models look with different polynomial specifications
########################################################
#make plots to pick ones to use
a1<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015a, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 1, title = "Age Adjusted All-Cause: Linear",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)
a2<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015a, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 2, title = "Age Adjusted All-Cause: Quadratic",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)
a3<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015a, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 3,title = "Age Adjusted All-Cause: Cubic",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)

h1<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015h, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 1, title = "Age Adjusted Heart Disease: Linear",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)
h2<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015h, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 2, title = "Age Adjusted Heart Disease: Quadratic",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)
h3<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015h, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 3,title = "Age Adjusted Heart Disease: Cubic",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)

c1<- 
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015c, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 1, title = "Age Adjusted Cancer: Linear",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)
c2<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015c, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 2, title = "Age Adjusted Heart Cancer: Quadratic",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)
c3<-
rdrobust::rdplot(merge.mortb$age_adjusted_rate_2015c, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 3,title = "Age Adjusted Heart Cancer: Cubic",
                 x.label = "Transformed IMU Score", y.label = "Age Adjusted Rate", ci = 95, hide = T)

a4<-
rdrobust::rdplot(merge.mortb$crude_rate_2015a, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 1, title = "Crude All-Cause: Linear",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
a5<-
rdrobust::rdplot(merge.mortb$crude_rate_2015a, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 2, title = "Crude All-Cause: Quadratic",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
a6<-
rdrobust::rdplot(merge.mortb$crude_rate_2015a, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 3,title = "Crude All-Cause: Cubic",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)

h4<-
rdrobust::rdplot(merge.mortb$crude_rate_2015h, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 1, title = "Crude Heart Disease: Linear",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
h5<-
rdrobust::rdplot(merge.mortb$crude_rate_2015h, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 2, title = "Crude Heart Disease: Quadratic",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
h6<-
rdrobust::rdplot(merge.mortb$crude_rate_2015h, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 3,title = "Crude Heart Disease: Cubic",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
c4<-
rdrobust::rdplot(merge.mortb$crude_rate_2015c, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 1, title = "Crude Cancer: Linear",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
c5<-
rdrobust::rdplot(merge.mortb$crude_rate_2015c, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 2, title = "Crude Heart Cancer: Quadratic",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
c6<-
rdrobust::rdplot(merge.mortb$crude_rate_2015c, 
                 merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
                 c = 0, all=TRUE, p = 3,title = "Crude Heart Cancer: Cubic",
                 x.label = "Transformed IMU Score", y.label = "Crude Rate", ci = 95, hide = T)
```


```{r}

ac1 <- 
a1$vars_bins %>%
  mutate(predicted_y = ifelse(rdplot_mean_bin <= 62,
                              a1$coef[2,1]*-1*rdplot_mean_bin+a1$coef[1,2],
                              a1$coef[2,2]*rdplot_mean_bin +a1$coef[1,1])) %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(a1$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = a1$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Linear")

ac2 <- 
a2$vars_bins %>%
  mutate(predicted_y = ifelse(rdplot_mean_bin <= 62,
                              a2$coef[2,1]*-1*rdplot_mean_bin+a2$coef[1,2],
                              a2$coef[2,2]*rdplot_mean_bin +a2$coef[1,1])) %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(a2$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = a2$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Quadratic")

ac3 <- 
a3$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(a3$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = a3$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Cubic")

hd1 <- 
h1$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(h1$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = h1$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Linear")

hd2 <- 
h2$vars_bins %>%
  mutate(predicted_y = ifelse(rdplot_mean_bin <= 62,
                              h2$coef[2,1]*-1*rdplot_mean_bin+h2$coef[1,2],
                              h2$coef[2,2]*rdplot_mean_bin +h2$coef[1,1])) %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(h2$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = h2$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Quadratic")

hd3 <- 
h3$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(h3$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = h3$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Cubic")

can1 <- 
c1$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(c1$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = c1$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Linear")

can2 <- 
c2$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(c2$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = c2$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Quadratic")

can3 <- 
c3$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(c3$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = c3$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Cubic")

##################################################
ac4 <- 
a4$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(a4$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = a4$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Linear")

ac5 <- 
a5$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(a5$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = a5$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Quadratic")

ac6 <- 
a6$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(a6$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = a6$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Cubic")

hd4 <- 
h4$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(h4$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = h4$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Linear")

hd5 <- 
h5$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(h5$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = h5$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Quadratic")

hd6 <- 
h6$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(h6$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = h6$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Cubic")

can4 <- 
c4$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(c4$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = c4$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Linear")

can5 <- 
c5$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(c5$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = c5$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Quadratic")

can6 <- 
c6$vars_bins %>%
  filter(!is.nan(rdplot_ci_r) & !is.nan(rdplot_mean_y) & !is.na(rdplot_ci_r) &
           rdplot_N != 1) %>%
  ggplot(aes(x = rdplot_mean_bin, y = rdplot_mean_y)) + 
  geom_point() +
  geom_ribbon(aes(ymin = rdplot_ci_l, ymax = rdplot_ci_r), alpha = .1) + theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_line(color= ifelse(c6$vars_poly$rdplot_x <= 62, "red", "blue"),
            aes(x=rdplot_x, y= rdplot_y), data = c6$vars_poly) +
  labs(x = "2014 Index of Medical Score", y = "Mortality Rate") +
  ggtitle("Cubic")

```


```{r, fig.cap="Age-Standardized (Left) and Crude (Right) All Cause Mortality FRDD Fits", fig.height=10, fig.width=8}
(ac1 + ac4)/ (ac2 + ac5) / (ac3 + ac6) + 
  plot_annotation(caption = "Lines represent predicted mortality rate for binned observations, and grey ribbons show 95% confidence intervals")

```

```{r, fig.cap = "Age-Standardized (Left) and Crude (Right) Heart Disease Mortality FRDD Fits", fig.height=10, fig.width=8}
(hd1 + hd4)/ (hd2 + hd5) / (hd3 + hd6)+ 
  plot_annotation(caption = "Lines represent predicted mortality rate for binned observations, and grey ribbons show 95% confidence intervals")
```


```{r,fig.cap = "Age-Standardized (Left) and Crude (Right) Cancer Mortality FRDD Fits", fig.height=10, fig.width=8}
(can1 + can4)/ (can2 + can5) / (can3 + can6)+ 
  plot_annotation(caption = "Lines represent predicted mortality rate for binned observations, and grey ribbons show 95% confidence intervals")
```


### Placebo Tests : Balance on Covariates

```{r}
pov <- rdrobust(y = merge.mortb$pv_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
old <- rdrobust(y = merge.mortb$percent_65_and_older_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
hhinc <- rdrobust(y = merge.mortb$median_household_income_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
unemp <- rdrobust(y = merge.mortb$unemployment_rate_2014, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
hsgrad <- rdrobust(y = merge.mortb$high_school_graduation_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
unins <- rdrobust(y = merge.mortb$uninsured_2014, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
obesi <- rdrobust(y = merge.mortb$adult_obesity_2012_2014, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
smoke <- rdrobust(y = merge.mortb$adult_smoking_value, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
inact <- rdrobust(y = merge.mortb$physical_inactivity_2012_2014, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
white <- rdrobust(y = merge.mortb$percent_non_hispanic_white_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
black <- rdrobust(y = merge.mortb$percent_non_hispanic_african_american_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
hisp <- rdrobust(y = merge.mortb$percent_hispanic_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
rura <- rdrobust(y = merge.mortb$percent_rural_raw_value_14, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
nine <- rdrobust(y = merge.mortb$age_adjusted_rate_1999a, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
five <- rdrobust(y = merge.mortb$age_adjusted_rate_2009a, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
four <- rdrobust(y = merge.mortb$age_adjusted_rate_2004a, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
nineh <- rdrobust(y = merge.mortb$age_adjusted_rate_1999h, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
fiveh <- rdrobust(y = merge.mortb$age_adjusted_rate_2009h, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
fourh <- rdrobust(y = merge.mortb$age_adjusted_rate_2004h, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
ninec <- rdrobust(y = merge.mortb$age_adjusted_rate_1999c, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
fivec <- rdrobust(y = merge.mortb$age_adjusted_rate_2009c, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)
fourc <- rdrobust(y = merge.mortb$age_adjusted_rate_2004c, 
              x = merge.mortb$x_tilde, fuzzy = merge.mortb$treatment,
              c = 0, all=TRUE , masspoints = F, p = 2)

#create a nice table of results
outcome <- c("Percent Poverty", "Percent Over 65",
             "Median HH Income", "Unemployment", "High School Graduation",
             "Uninsured", "Adult Obesity", "Smoking", "Physical Inactivity",
             "Percent White", "Percent Black", "Percent Hispanic", "Percent Rural",
             "1999 All Cause Mortality", "2004 All Cause Mortality", "2009 All Cause Mortality",
             "1999 Heart Disease Mortality", "2004 Heart Disease Mortality", 
             "2009 Heart Disease Mortality",
             "1999 Cancer Mortality", "2004 Cancer Mortality", "2009 Cancer Mortality")

tau.rdd <- c(pov$Estimate[2],old$Estimate[2]
             ,hhinc$Estimate[2], unemp$Estimate[2], hsgrad$Estimate[2],
             unins$Estimate[2], obesi$Estimate[2], smoke$Estimate[2],
             inact$Estimate[2], white$Estimate[2], black$Estimate[2],
             hisp$Estimate[2], rura$Estimate[2], nine$Estimate[2],
             four$Estimate[2], five$Estimate[2], nineh$Estimate[2], fourh$Estimate[2],
             fiveh$Estimate[2], ninec$Estimate[2], fourc$Estimate[2],
             five$Estimate[2])

ci.robu <- c(paste0(round(pov$ci[3,1],2), " - ", round(pov$ci[3,2],2)),
             paste0(round(old$ci[3,1],2), " - ", round(old$ci[3,2],2)),
             paste0(round(hhinc$ci[3,1],2), " - ", round(hhinc$ci[3,2],2)),
             paste0(round(unemp$ci[3,1],2), " - ", round(unemp$ci[3,2],2)),
             paste0(round(hsgrad$ci[3,1],2), " - ", round(hsgrad$ci[3,2],2)),
             paste0(round(unins$ci[3,1],2), " - ", round(unins$ci[3,2],2)),
             paste0(round(obesi$ci[3,1],2), " - ", round(obesi$ci[3,2],2)),
             paste0(round(smoke$ci[3,1],2), " - ", round(smoke$ci[3,2],2)),
             paste0(round(inact$ci[3,1],2), " - ", round(inact$ci[3,2],2)),
             paste0(round(white$ci[3,1],2), " - ", round(white$ci[3,2],2)),
             paste0(round(black$ci[3,1],2), " - ", round(black$ci[3,2],2)),
             paste0(round(hisp$ci[3,1],2), " - ", round(hisp$ci[3,2],2)),
             paste0(round(rura$ci[3,1],2), " - ", round(rura$ci[3,2],2)),
             paste0(round(nine$ci[3,1],2), " - ", round(nine$ci[3,2],2)),
             paste0(round(four$ci[3,1],2), " - ", round(four$ci[3,2],2)),
             paste0(round(five$ci[3,1],2), " - ", round(five$ci[3,2],2)),
             paste0(round(nineh$ci[3,1],2), " - ", round(nineh$ci[3,2],2)),
             paste0(round(fourh$ci[3,1],2), " - ", round(fourh$ci[3,2],2)),
             paste0(round(fiveh$ci[3,1],2), " - ", round(fiveh$ci[3,2],2)),
             paste0(round(ninec$ci[3,1],2), " - ", round(ninec$ci[3,2],2)),
             paste0(round(fourc$ci[3,1],2), " - ", round(fourc$ci[3,2],2)),
             paste0(round(fivec$ci[3,1],2), " - ", round(fivec$ci[3,2],2))
             )

#bind together for table
res.tab <- cbind.data.frame(outcome, tau.rdd, ci.robu)
res.tab$tau.rdd <- round(res.tab$tau.rdd, 2)

names(res.tab) <- c("Outcome", "Estimate", "Robust")

res.tab %>%
#specify which ones should be bold
  mutate(
     Robust = cell_spec(Robust, bold = ifelse(substr(Robust,1,1)!= "-", T, F))) %>%
  kable("latex", booktabs = T, escape = F, align= c('l', 'r', 'r', 'r', 'r', 'r'),
        caption = "Placebo Effects of NHSC Participation") %>%
  kable_styling(row_label_position = "l",) %>%
  footnote(general = "Estimates represent tau FRD using a local regression with a triangular kernel")%>%
  add_footnote(label = "Bold face denotes statistical significance (p < 0.05)") %>%
  add_footnote(label = "All mortality rates are age-standardized")

```


### Placebo Tests: Using Alternate Cutoffs
Here, the reader may note that I have not included placebo cutoffs above the actual cutoff. The reason being is that it is generally suggested to restrict the sample for placebo cutoffs to only observations above or below the true cutoff in order to not impose constraints at the actual value of the cutoff into the local regression. Restricting to only observations above the sample leaves no possibility for instrumentation, as 0 counties above the cutoff were eligible for the program.

```{r, fig.cap="Placebo Thresholds. Ribbon Shows RBC 95% Confidence Interval"}
make_rdd_plot_data_placebo <- function(outcome, cut = data$x_tilde, cutoff){
  
  ik.bw <- IKbandwidth(Y = outcome,
                       X = cut, cutpoint = cutoff)

  tempframe <- cbind.data.frame(c(ik.bw),
                                rep(0,1),
                                rep(0,1),
                                rep(0,1),
                                rep(0,1),
                                rep(0,1),
                                rep(0,1),
                                rep(0,1))

  names(tempframe) <- c("bw", "estimate_bc", "estimate_us", "upper_bc","lower_bc",
                         "upper_rob","lower_rob",
                         "nObs")

  for (i in 1:nrow(tempframe)){
    j <- tempframe[i,1]
      rd <- rdrobust(y = outcome, 
                x = cut, fuzzy = data$treatment, h = ik.bw,
                c = cutoff, all=TRUE , masspoints = F, p = 2)
     tempframe[i,] <- c(j,
                       rd$Estimate[2],
                       rd$Estimate[2],
                       rd$ci[2,2], rd$ci[2,1],
                       rd$ci[3,2], rd$ci[3,1],
                       sum(rd$N_h))
  }
  
  
  return(tempframe)  
}

data <- merge.mortb[merge.mortb$x_tilde<0,]
plac.cut <- 
purrr::map_df(.x = seq(-21, -.4, .1), 
               .f = ~make_rdd_plot_data_placebo(outcome = data$age_adjusted_rate_2015a,
                                               cutoff = .x))
plac.cut$cutoff <- seq(-21,-.4,.1)


  plac.cut %>%
    filter(lower_rob > -1000) %>%
    ggplot(aes(x = cutoff, y = estimate_bc)) + geom_line(color = "black") +
    #geom_ribbon(aes(ymin = lower_rob, ymax = upper_rob), alpha =.3, fill = "#00BFC4") +
    #geom_point(aes(x = cutoff, y = estimate_us), color = "#F8766D") + 
    geom_ribbon(aes(ymin = lower_bc, ymax = upper_bc), alpha =.3, fill = "#F8766D") +
    theme_bw() + labs(x = "Placebo Cutoff Value (0 = true)", y = "LATE")+
    #geom_text(aes(label = paste(nObs)), nudge_y = 250, nudge_x = -.2,
    #          check_overlap = TRUE, angle = 60)+
    geom_hline(yintercept = 0, color = "black")+
    geom_vline(xintercept = 0, color = "red")+
    xlim(c(-21, 2))+ theme(panel.grid.minor.x = element_blank()) + 
    coord_cartesian(ylim = c(-1000, 2000))
   





```



